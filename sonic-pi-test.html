<!DOCTYPE html>
<html>
<head>
  <title>Sonic Pi WebSocket Controller</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      display: flex;
    }
    .sidebar {
      width: 250px;
      background-color: #222;
      color: white;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      z-index: 100;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .sidebar-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0;
    }
    .main-content {
      margin-left: 250px;
      max-width: 900px;
      width: 100%;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .input-group {
      display: flex;
      gap: 10px;
    }
    input, select {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input[type="number"] {
      width: 80px;
    }
    input[type="text"] {
      flex-grow: 1;
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    #output {
      border: 1px solid #ddd;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background-color: #fff;
      border-radius: 4px;
    }
    .examples {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .example-button {
      padding: 10px;
      background-color: #2196F3;
      color: white;
      border: none;
      cursor: pointer;
      text-align: center;
      border-radius: 4px;
    }
    .example-button:hover {
      background-color: #0b7dda;
    }
    .status {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .connected {
      background-color: #dff0d8;
      color: #3c763d;
    }
    .disconnected {
      background-color: #f2dede;
      color: #a94442;
    }
    .connection-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .port-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .port-input-group input {
      width: 80px;
    }
    .port-input-group label {
      font-weight: bold;
    }
    .connection-message {
      font-weight: bold;
    }
    .scale-options {
      margin-top: 8px;
      padding: 8px;
      background-color: #f8f8f8;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .scale-checkbox {
      margin-right: 8px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0;
    }
    .loop-container, .note-container {
      margin-top: 20px;
    }
    .loop-card, .note-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      position: relative;
    }
    .loop-controls, .note-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .loop-actions, .note-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .remove-loop, .remove-note {
      background-color: #f44336;
    }
    .remove-loop:hover, .remove-note:hover {
      background-color: #d32f2f;
    }
    .play-loop, .play-note {
      background-color: #4CAF50;
    }
    .stop-loop {
      background-color: #f44336;
    }
    .note-number {
      position: absolute;
      top: 5px;
      right: 15px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #2196F3;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 14px;
    }
    .note-card.playing .note-number {
      background-color: #4CAF50;
      animation: pulse 0.5s;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .loop-status {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #ccc;
    }
    .loop-running {
      background-color: #4CAF50;
    }
    .control-group {
      display: flex;
      flex-direction: column;
    }
    .control-group label {
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }
    .note-selector {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
    }
    .note-button {
      padding: 5px;
      font-size: 12px;
    }
    .tab-container {
      margin-top: 20px;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .tab-button {
      padding: 10px 20px;
      background-color: #f1f1f1;
      border: none;
      border-radius: 4px 4px 0 0;
      cursor: pointer;
      margin-right: 5px;
    }
    .tab-button.active {
      background-color: #4CAF50;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .octave-selector {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    .octave-button {
      flex: 1;
      padding: 5px;
      font-size: 12px;
      background-color: #e0e0e0;
    }
    .octave-button.selected {
      background-color: #2196F3;
      color: white;
    }
    .effects-section {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .effects-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .effects-header h3 {
      margin: 0;
      font-size: 16px;
    }
    .add-effect-btn {
      font-size: 12px;
      padding: 5px 10px;
      background-color: #673AB7;
    }
    .effect-card {
      background-color: #f8f8f8;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #eee;
    }
    .effect-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .effect-title {
      font-weight: bold;
      color: #333;
    }
    .effect-params {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .effect-param {
      display: flex;
      flex-direction: column;
    }
    .effect-param label {
      font-size: 12px;
      margin-bottom: 3px;
    }
    .remove-effect {
      background-color: #f44336;
      font-size: 12px;
      padding: 3px 6px;
    }
    .sidebar-empty-message {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 20px 0;
    }
    .sidebar-loop-item {
      background-color: #333;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
      border-left: 3px solid #4CAF50;
    }
    .sidebar-loop-item.inactive {
      border-left-color: #f44336;
    }
    .sidebar-loop-name {
      font-weight: bold;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-loop-details {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 8px;
    }
    .sidebar-loop-controls {
      display: flex;
      gap: 5px;
    }
    .sidebar-loop-controls button {
      flex: 1;
      padding: 4px;
      font-size: 12px;
    }
    .clear-all-btn {
      background-color: #f44336;
      font-size: 12px;
      padding: 4px 8px;
    }
    .notes-list {
      margin: 10px 0;
      padding: 10px;
      background-color: #f8f8f8;
      border-radius: 4px;
      border: 1px solid #eee;
      min-height: 50px;
    }
    
    .note-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    
    .add-note-btn {
      background-color: #2196F3;
      font-size: 12px;
      padding: 4px 8px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">Active Loops</h2>
      <button onclick="clearAllLoops()" class="clear-all-btn">Clear All</button>
    </div>
    <div id="sidebar-loops">
      <!-- Loop items will be added here -->
      <div class="sidebar-empty-message">No active loops</div>
    </div>
  </div>
  
  <div class="main-content">
    <h1>Sonic Pi WebSocket Controller</h1>
    
    <div class="container">
      <div id="connection-status" class="status disconnected">
        <div class="connection-form">
          <div class="port-input-group">
            <label for="port-number">Sonic Pi Port:</label>
            <input type="number" id="port-number" value="4560" min="1" max="65535">
            <button id="connect-button" onclick="connectToSonicPi()">Connect</button>
          </div>
          <div class="connection-message">Disconnected</div>
        </div>
      </div>
      
      <div class="tab-container">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="openTab(event, 'simple-commands')">Simple Commands</button>
          <button class="tab-button" onclick="openTab(event, 'loop-creator')">Loop Creator</button>
          <button class="tab-button" onclick="openTab(event, 'notes-creator')">Notes</button>
        </div>
        
        <div id="simple-commands" class="tab-content active">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Send Custom Command</h2>
            </div>
            <div class="input-group">
              <input id="message" type="text" placeholder="Enter Sonic Pi code (e.g., play 60)">
              <button onclick="sendMessage()">Send</button>
            </div>
            
            <h3>Examples</h3>
            <div class="examples">
              <button class="example-button" onclick="sendExample('play 60')">Play Middle C</button>
              <button class="example-button" onclick="sendExample('play_chord [60, 64, 67]')">Play C Major Chord</button>
              <button class="example-button" onclick="sendExample('use_synth :fm; play 72')">FM Synth High C</button>
              <button class="example-button" onclick="sendExample('sample :loop_amen')">Amen Break</button>
              <button class="example-button" onclick="sendExample('use_bpm 120; 16.times do\n  sample :bd_haus, rate: 1\n  sleep 0.5\nend')">Drum Loop</button>
              <button class="example-button" onclick="sendExample('use_synth :tb303; play_pattern_timed scale(:e3, :minor), 0.25, release: 0.1')">TB303 Pattern</button>
            </div>
          </div>
        </div>
        
        <div id="loop-creator" class="tab-content">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Create New Loop</h2>
              <button onclick="addNewLoop()">+ Add Loop</button>
            </div>
            
            <div id="loops-container" class="loop-container">
              <!-- Loop cards will be added here -->
            </div>
          </div>
        </div>
        
        <div id="notes-creator" class="tab-content">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Create Individual Notes</h2>
              <button onclick="addNewNote()">+ Add Note</button>
            </div>
            
            <div id="notes-container" class="note-container">
              <!-- Note cards will be added here -->
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Response</h2>
          <button onclick="clearOutput()">Clear</button>
        </div>
        <div id="output"></div>
      </div>
    </div>
  </div>

  <script>
    let ws;
    let reconnectInterval;
    let loopCounter = 0;
    let noteCounter = 0;
    let activeLoops = {};
    
    // Available effects in Sonic Pi with their common parameters
    const effects = {
      reverb: {
        name: "Reverb",
        params: {
          mix: { default: 0.5, min: 0, max: 1, step: 0.1 },
          room: { default: 0.6, min: 0, max: 1, step: 0.1 },
          damp: { default: 0.5, min: 0, max: 1, step: 0.1 }
        }
      },
      echo: {
        name: "Echo",
        params: {
          mix: { default: 0.5, min: 0, max: 1, step: 0.1 },
          phase: { default: 0.25, min: 0, max: 4, step: 0.1 },
          decay: { default: 2, min: 0, max: 10, step: 0.1 }
        }
      },
      distortion: {
        name: "Distortion",
        params: {
          mix: { default: 0.5, min: 0, max: 1, step: 0.1 },
          distort: { default: 0.5, min: 0, max: 1, step: 0.1 }
        }
      },
      wobble: {
        name: "Wobble",
        params: {
          mix: { default: 0.5, min: 0, max: 1, step: 0.1 },
          phase: { default: 0.5, min: 0, max: 5, step: 0.1 },
          cutoff_min: { default: 60, min: 0, max: 130, step: 1 },
          cutoff_max: { default: 100, min: 0, max: 130, step: 1 }
        }
      },
      bitcrusher: {
        name: "Bitcrusher",
        params: {
          mix: { default: 0.5, min: 0, max: 1, step: 0.1 },
          bits: { default: 8, min: 1, max: 16, step: 1 },
          sample_rate: { default: 10000, min: 1000, max: 44100, step: 1000 }
        }
      },
      flanger: {
        name: "Flanger",
        params: {
          mix: { default: 0.5, min: 0, max: 1, step: 0.1 },
          phase: { default: 4, min: 0.1, max: 10, step: 0.1 },
          depth: { default: 5, min: 0.1, max: 10, step: 0.1 }
        }
      },
      vowel: {
        name: "Vowel",
        params: {
          mix: { default: 0.5, min: 0, max: 1, step: 0.1 },
          vowel_sound: { default: 1, min: 1, max: 5, step: 1 }
        }
      }
    };
    
    // Available synths in Sonic Pi
    const synths = [
      'sine', 'saw', 'beep', 'tri', 'square', 'pulse', 'subpulse', 'dpulse', 
      'fm', 'mod_fm', 'mod_saw', 'mod_sine', 'mod_tri', 'mod_pulse', 
      'tb303', 'supersaw', 'hoover', 'prophet', 'zawa', 'dsaw', 'dull_bell', 
      'pretty_bell', 'chiplead', 'chipbass', 'chip_noise', 'blade', 'piano'
    ];
    
    // Notes for the note selector
    const notes = [
      'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'
    ];
    
    // Available scales in Sonic Pi
    const scales = [
      'major', 'minor', 'major_pentatonic', 'minor_pentatonic', 'ionian', 'dorian', 'phrygian',
      'lydian', 'mixolydian', 'aeolian', 'locrian', 'blues_major', 'blues_minor', 'harmonic_minor',
      'melodic_minor', 'whole_tone', 'chromatic', 'spanish', 'zhi', 'ritusen', 'egyptian',
      'hindu', 'hirajoshi', 'hungarian_minor', 'romanian_minor', 'indian', 'diminished', 'augmented'
    ];
    
    // MIDI note numbers for each note in different octaves
    const midiNotes = {
      'C': [24, 36, 48, 60, 72, 84, 96],
      'C#': [25, 37, 49, 61, 73, 85, 97],
      'D': [26, 38, 50, 62, 74, 86, 98],
      'D#': [27, 39, 51, 63, 75, 87, 99],
      'E': [28, 40, 52, 64, 76, 88, 100],
      'F': [29, 41, 53, 65, 77, 89, 101],
      'F#': [30, 42, 54, 66, 78, 90, 102],
      'G': [31, 43, 55, 67, 79, 91, 103],
      'G#': [32, 44, 56, 68, 80, 92, 104],
      'A': [33, 45, 57, 69, 81, 93, 105],
      'A#': [34, 46, 58, 70, 82, 94, 106],
      'B': [35, 47, 59, 71, 83, 95, 107]
    };
    
    function connectWebSocket() {
      ws = new WebSocket('ws://localhost:3000');
      
      ws.onopen = () => {
        document.getElementById('connection-status').className = 'status connected';
        document.querySelector('.connection-message').textContent = 'Connected to WebSocket Server';
        clearInterval(reconnectInterval);
        logMessage('Connected to server');
      };
      
      ws.onmessage = (event) => {
        logMessage(`Received: ${event.data}`);
      };
      
      ws.onclose = () => {
        document.getElementById('connection-status').className = 'status disconnected';
        document.querySelector('.connection-message').textContent = 'Disconnected (trying to reconnect...)';
        logMessage('Disconnected from server');
        
        // Try to reconnect
        if (!reconnectInterval) {
          reconnectInterval = setInterval(connectWebSocket, 5000);
        }
      };
      
      ws.onerror = (error) => {
        logMessage('WebSocket error');
        console.error('WebSocket error:', error);
      };
    }
    
    function connectToSonicPi() {
      const portNumber = parseInt(document.getElementById('port-number').value);
      
      if (isNaN(portNumber) || portNumber < 1 || portNumber > 65535) {
        logMessage('Invalid port number. Please enter a number between 1 and 65535.');
        return;
      }
      
      // Update the connection message
      document.querySelector('.connection-message').textContent = 'Connecting...';
      
      // Store the port number for later use
      window.sonicPiPort = portNumber;
      
      // Connect to the WebSocket server
      connectWebSocket();
      
      logMessage(`Attempting to connect to Sonic Pi on port ${portNumber}`);
    }
    
    function sendMessage() {
      const message = document.getElementById('message').value;
      if (!message) return;
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Send just the code, not a JSON object
        ws.send(message);
        
        logMessage(`Sent: ${message}`);
        document.getElementById('message').value = '';
      } else {
        logMessage('Cannot send message: not connected to server');
      }
    }
    
    function sendExample(example) {
      document.getElementById('message').value = example;
      sendMessage();
    }
    
    function logMessage(message) {
      const output = document.getElementById('output');
      const time = new Date().toLocaleTimeString();
      output.innerHTML += `<p><strong>${time}</strong>: ${message}</p>`;
      output.scrollTop = output.scrollHeight;
    }
    
    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }
    
    function openTab(evt, tabName) {
      // Hide all tab content
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
      
      // Remove active class from all tab buttons
      const tabButtons = document.getElementsByClassName('tab-button');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }
      
      // Show the selected tab content and mark the button as active
      document.getElementById(tabName).classList.add('active');
      evt.currentTarget.classList.add('active');
    }
    
    function addNewLoop() {
      loopCounter++;
      const loopId = `loop-${loopCounter}`;
      const loopsContainer = document.getElementById('loops-container');
      
      // Create synth options
      let synthOptions = '';
      synths.forEach(synth => {
        synthOptions += `<option value=":${synth}">:${synth}</option>`;
      });
      
      // Create note options
      let noteOptions = '';
      notes.forEach(note => {
        noteOptions += `<option value="${note}">${note}</option>`;
      });
      
      // Create the loop card
      const loopCard = document.createElement('div');
      loopCard.className = 'loop-card';
      loopCard.id = loopId;
      loopCard.innerHTML = `
        <div class="loop-status" id="${loopId}-status"></div>
        <div class="control-group">
          <label for="${loopId}-name">Loop Name:</label>
          <input type="text" id="${loopId}-name" value="my_loop_${loopCounter}" placeholder="Enter loop name" onchange="updateSidebarLoops()">
        </div>
        
        <div class="loop-controls">
          <div class="control-group">
            <label for="${loopId}-synth">Synth:</label>
            <select id="${loopId}-synth">
              ${synthOptions}
            </select>
          </div>
          
          <div class="control-group">
            <label>Notes:</label>
            <div id="${loopId}-notes-list" class="notes-list">
              <!-- Notes will be added here -->
            </div>
            <button class="add-note-btn" onclick="addNoteToLoopList('${loopId}')">+ Add Note</button>
          </div>
          
          <div class="control-group">
            <label for="${loopId}-sleep">Sleep Time:</label>
            <select id="${loopId}-sleep">
              <option value="1">1/4 note (Quarter note)</option>
              <option value="0.5" selected>1/8 note (Eighth note)</option>
              <option value="0.25">1/16 note (Sixteenth note)</option>
              <option value="0.125">1/32 note (Thirty-second note)</option>
            </select>
          </div>
          
          <div class="control-group">
            <label>
              <input type="checkbox" id="${loopId}-use-tick"> Use Tick (Play Notes Sequentially)
            </label>
          </div>
          
          <div class="control-group">
            <label for="${loopId}-attack">Attack:</label>
            <input type="number" id="${loopId}-attack" value="0" min="0" max="5" step="0.1">
          </div>
          
          <div class="control-group">
            <label for="${loopId}-sustain">Sustain:</label>
            <input type="number" id="${loopId}-sustain" value="0" min="0" max="5" step="0.1">
          </div>
          
          <div class="control-group">
            <label for="${loopId}-release">Release:</label>
            <input type="number" id="${loopId}-release" value="1" min="0" max="5" step="0.1">
          </div>
        </div>
        
        <div class="loop-actions">
          <button class="play-loop" onclick="startLoop('${loopId}')">Start Loop</button>
          <button class="stop-loop" onclick="stopLoop('${loopId}')">Stop Loop</button>
          <button class="remove-loop" onclick="removeLoop('${loopId}')">Remove</button>
        </div>
        
        <div class="effects-section">
          <div class="effects-header">
            <h3>Effects</h3>
            <button class="add-effect-btn" onclick="addEffectToLoop('${loopId}')">Add Effect</button>
          </div>
          <div id="${loopId}-effects-container" class="effects-container">
            <!-- Effects will be added here -->
          </div>
        </div>
      `;
      
      loopsContainer.appendChild(loopCard);
      
      // Add an initial note to the loop
      addNoteToLoopList(loopId);
      
      // Update the sidebar to show the new loop
      updateSidebarLoops();
    }
    
    function selectLoopOctave(loopId, octave) {
      const loopCard = document.getElementById(loopId);
      if (!loopCard) return;
      
      // Update the octave buttons within this loop card
      const octaveButtons = loopCard.querySelectorAll('.octave-button');
      octaveButtons.forEach((button, index) => {
        if (index === octave - 1) {
          button.classList.add('selected');
        } else {
          button.classList.remove('selected');
        }
      });
      
      // Update the MIDI value
      updateLoopNoteValue(loopId);
    }
    
    function toggleLoopScaleMode(loopId) {
      const useScale = document.getElementById(`${loopId}-use-scale`).checked;
      document.getElementById(`${loopId}-scale-options`).style.display = useScale ? 'block' : 'none';
    }
    
    function updateLoopNoteValue(loopId) {
      const loopCard = document.getElementById(loopId);
      if (!loopCard) {
        console.log('Loop card not found:', loopId);
        return;
      }
      
      const noteSelect = loopCard.querySelector('.note-select');
      const selectedNote = noteSelect.value;
      
      // Find which octave is selected
      const octaveButtons = loopCard.querySelectorAll('.octave-button');
      let selectedOctave = 3; // Default to octave 3
      
      octaveButtons.forEach((button, index) => {
        if (button.classList.contains('selected')) {
          selectedOctave = index + 1;
        }
      });
      
      // Get the MIDI value for this note and octave
      const midiValue = midiNotes[selectedNote][selectedOctave - 1];
      
      // Update the hidden input
      const midiInput = loopCard.querySelector('.midi-value');
      if (midiInput) {
        midiInput.value = midiValue;
        console.log(`Updated note ${selectedNote} octave ${selectedOctave} to MIDI value ${midiValue}`);
      }
    }
    
    function addNoteToLoopList(loopId) {
      const notesList = document.getElementById(`${loopId}-notes-list`);
      const noteId = `${loopId}-note-${Date.now()}`;
      
      // Create note options
      let noteOptions = '';
      notes.forEach(note => {
        noteOptions += `<option value="${note}">${note}</option>`;
      });
      
      const noteItem = document.createElement('div');
      noteItem.className = 'note-item';
      noteItem.id = noteId;
      noteItem.innerHTML = `
        <select class="note-select" onchange="updateLoopNoteValue('${noteId}')">
          ${noteOptions}
        </select>
        <div class="octave-selector">
          <button class="octave-button" onclick="selectLoopOctave('${noteId}', 1)">1</button>
          <button class="octave-button" onclick="selectLoopOctave('${noteId}', 2)">2</button>
          <button class="octave-button selected" onclick="selectLoopOctave('${noteId}', 3)">3</button>
          <button class="octave-button" onclick="selectLoopOctave('${noteId}', 4)">4</button>
          <button class="octave-button" onclick="selectLoopOctave('${noteId}', 5)">5</button>
          <button class="octave-button" onclick="selectLoopOctave('${noteId}', 6)">6</button>
          <button class="octave-button" onclick="selectLoopOctave('${noteId}', 7)">7</button>
        </div>
        <input type="hidden" class="midi-value" value="60">
        <button class="remove-note" onclick="removeNoteFromLoop('${noteId}')">Remove</button>
      `;
      
      notesList.appendChild(noteItem);
      
      // Initialize with default note (C) and octave 3
      const noteSelect = noteItem.querySelector('.note-select');
      noteSelect.value = 'C';
      const midiInput = noteItem.querySelector('.midi-value');
      midiInput.value = midiNotes['C'][2]; // Index 2 is octave 3
      console.log(`Initialized note with MIDI value: ${midiInput.value}`);
    }
    
    function removeNoteFromLoop(noteId) {
      const noteItem = document.getElementById(noteId);
      if (noteItem) {
        noteItem.remove();
      }
    }
    
    function getLoopNotes(loopId) {
      const notesList = document.getElementById(`${loopId}-notes-list`);
      if (!notesList) return [];
      
      const noteItems = notesList.querySelectorAll('.note-item');
      const midiValues = [];
      
      noteItems.forEach(noteItem => {
        const midiInput = noteItem.querySelector('.midi-value');
        if (midiInput && midiInput.value) {
          const midiValue = parseInt(midiInput.value);
          midiValues.push(midiValue);
        }
      });
      
      console.log('Loop notes:', midiValues);
      return midiValues;
    }
    
    function generateLoopCode(loopId) {
      const loopName = document.getElementById(`${loopId}-name`).value;
      const synth = document.getElementById(`${loopId}-synth`).value;
      const sleep = document.getElementById(`${loopId}-sleep`).value;
      const attack = document.getElementById(`${loopId}-attack`).value;
      const sustain = document.getElementById(`${loopId}-sustain`).value;
      const release = document.getElementById(`${loopId}-release`).value;
      
      // Get all notes for this loop
      const midiValues = getLoopNotes(loopId);
      
      if (midiValues.length === 0) {
        logMessage(`Warning: Loop ${loopId} has no notes defined`);
        return '';
      }
      
      // Get effects
      const effectsData = getEffectsForElement(loopId);
      
      // Build the Sonic Pi code for the loop
      let code = `live_loop :${loopName} do\n`;
      
      // Add synth selection
      code += `  use_synth ${synth}\n`;
      
      // Open effects blocks
      effectsData.forEach(effect => {
        code += `  with_fx :${effect.type}`;
        
        // Add effect parameters
        const paramStrings = [];
        for (const [paramName, paramValue] of Object.entries(effect.params)) {
          paramStrings.push(`${paramName}: ${paramValue}`);
        }
        
        if (paramStrings.length > 0) {
          code += `, ${paramStrings.join(', ')}`;
        }
        
        code += ' do\n';
      });
      
      // Indent based on number of effects
      const indent = '  ' + '  '.repeat(effectsData.length);
      
      // Add notes with parameters
      if (midiValues.length === 1) {
        code += `${indent}play ${midiValues[0]}`;
      } else {
        const useTick = document.getElementById(`${loopId}-use-tick`).checked;
        if (useTick) {
          // Convert MIDI values to note names with octaves for ring syntax
          const noteRings = midiValues.map(midi => {
            const noteNames = Object.entries(midiNotes);
            for (const [note, values] of noteNames) {
              const octaveIndex = values.indexOf(parseInt(midi));
              if (octaveIndex !== -1) {
                return `:${note.toLowerCase()}${octaveIndex + 1}`;
              }
            }
            return midi; // Fallback to MIDI value if note name not found
          });
          code += `${indent}play ring(${noteRings.join(', ')}).tick`;
        } else {
          code += `${indent}play_chord [${midiValues.join(', ')}]`;
        }
      }
      
      // Only add parameters if they have non-zero values
      const params = [];
      if (parseFloat(attack) > 0) params.push(`attack: ${attack}`);
      if (parseFloat(sustain) > 0) params.push(`sustain: ${sustain}`);
      if (parseFloat(release) > 0) params.push(`release: ${release}`);
      
      if (params.length > 0) {
        code += `, ${params.join(', ')}`;
      }
      
      code += `\n${indent}sleep ${sleep}\n`;
      
      // Close all effect blocks
      for (let i = effectsData.length - 1; i >= 0; i--) {
        code += `${'  '.repeat(i + 1)}end\n`;
      }
      
      // Close the loop block
      code += `end`;
      
      return code;
    }
    
    function addNewNote() {
      noteCounter++;
      const noteId = `note-${noteCounter}`;
      const notesContainer = document.getElementById('notes-container');
      
      // Create synth options
      let synthOptions = '';
      synths.forEach(synth => {
        synthOptions += `<option value=":${synth}">:${synth}</option>`;
      });
      
      // Create note options
      let noteOptions = '';
      notes.forEach(note => {
        noteOptions += `<option value="${note}">${note}</option>`;
      });
      
      // Create the note card
      const noteCard = document.createElement('div');
      noteCard.className = 'note-card';
      noteCard.id = noteId;
      noteCard.innerHTML = `
        <div class="note-controls">
          <div class="note-number">${noteCounter <= 9 ? noteCounter : ''}</div>
          <div class="control-group">
            <label for="${noteId}-synth">Synth:</label>
            <select id="${noteId}-synth">
              ${synthOptions}
            </select>
          </div>
          
          <div class="control-group">
            <label for="${noteId}-note">Note:</label>
            <select id="${noteId}-note" onchange="updateNoteValue('${noteId}')">
              ${noteOptions}
            </select>
            <div class="octave-selector" id="${noteId}-octave-selector">
              <button class="octave-button" onclick="selectOctave('${noteId}', 1)">1</button>
              <button class="octave-button" onclick="selectOctave('${noteId}', 2)">2</button>
              <button class="octave-button selected" onclick="selectOctave('${noteId}', 3)">3</button>
              <button class="octave-button" onclick="selectOctave('${noteId}', 4)">4</button>
              <button class="octave-button" onclick="selectOctave('${noteId}', 5)">5</button>
              <button class="octave-button" onclick="selectOctave('${noteId}', 6)">6</button>
              <button class="octave-button" onclick="selectOctave('${noteId}', 7)">7</button>
            </div>
            <input type="hidden" id="${noteId}-midi-value" value="60">
          </div>
          
          <div class="control-group">
            <label>
              <input type="checkbox" id="${noteId}-use-scale" onchange="toggleNoteScaleMode('${noteId}')"> Use Scale
            </label>
            <div id="${noteId}-scale-options" style="display: none; margin-top: 5px;">
              <label for="${noteId}-scale-type">Scale Type:</label>
              <select id="${noteId}-scale-type">
                ${scales.map(scale => `<option value=":${scale}">:${scale}</option>`).join('')}
              </select>
            </div>
          </div>
          
          <div class="control-group">
            <label for="${noteId}-attack">Attack:</label>
            <input type="number" id="${noteId}-attack" value="0" min="0" max="5" step="0.1">
          </div>
          
          <div class="control-group">
            <label for="${noteId}-sustain">Sustain:</label>
            <input type="number" id="${noteId}-sustain" value="0" min="0" max="5" step="0.1">
          </div>
          
          <div class="control-group">
            <label for="${noteId}-release">Release:</label>
            <input type="number" id="${noteId}-release" value="1" min="0" max="5" step="0.1">
          </div>
          
          <div class="control-group">
            <label for="${noteId}-amp">Amplitude:</label>
            <input type="number" id="${noteId}-amp" value="1" min="0" max="5" step="0.1">
          </div>
        </div>
        
        <div class="note-actions">
          <button class="play-note" onclick="playNote('${noteId}')">Play Note</button>
          <button class="remove-note" onclick="removeNote('${noteId}')">Remove</button>
        </div>
        
        <div class="effects-section">
          <div class="effects-header">
            <h3>Effects</h3>
            <button class="add-effect-btn" onclick="addEffectToNote('${noteId}')">Add Effect</button>
          </div>
          <div id="${noteId}-effects-container" class="effects-container">
            <!-- Effects will be added here -->
          </div>
        </div>
      `;
      
      notesContainer.appendChild(noteCard);
      updateNoteValue(noteId); // Initialize the MIDI value
    }
    
    function selectOctave(noteId, octave) {
      const noteItem = document.getElementById(noteId);
      if (!noteItem) return;
      
      // Update the octave buttons within this note item
      const octaveButtons = noteItem.querySelectorAll('.octave-button');
      octaveButtons.forEach((button, index) => {
        if (index === octave - 1) {
          button.classList.add('selected');
        } else {
          button.classList.remove('selected');
        }
      });
      
      // Update the MIDI value
      updateLoopNoteValue(noteId);
    }
    
    function updateNoteValue(noteId) {
      const noteSelect = document.getElementById(`${noteId}-note`);
      const selectedNote = noteSelect.value;
      
      // Find which octave is selected
      const octaveButtons = document.querySelectorAll(`#${noteId}-octave-selector .octave-button`);
      let selectedOctave = 3; // Default to octave 3
      
      octaveButtons.forEach((button, index) => {
        if (button.classList.contains('selected')) {
          selectedOctave = index + 1;
        }
      });
      
      // Get the MIDI value for this note and octave
      const midiValue = midiNotes[selectedNote][selectedOctave - 1];
      
      // Update the hidden input
      document.getElementById(`${noteId}-midi-value`).value = midiValue;
    }
    
    function generateNoteCode(noteId) {
      const synth = document.getElementById(`${noteId}-synth`).value;
      const midiValue = document.getElementById(`${noteId}-midi-value`).value;
      const attack = document.getElementById(`${noteId}-attack`).value;
      const sustain = document.getElementById(`${noteId}-sustain`).value;
      const release = document.getElementById(`${noteId}-release`).value;
      const amp = document.getElementById(`${noteId}-amp`).value;
      const useScale = document.getElementById(`${noteId}-use-scale`).checked;
      
      // Get effects
      const effectsData = getEffectsForElement(noteId);
      
      // Build the Sonic Pi code for the note
      let code = `use_synth ${synth}\n`;
      
      // Open effects blocks
      effectsData.forEach(effect => {
        code += `with_fx :${effect.type}`;
        
        // Add effect parameters
        const paramStrings = [];
        for (const [paramName, paramValue] of Object.entries(effect.params)) {
          paramStrings.push(`${paramName}: ${paramValue}`);
        }
        
        if (paramStrings.length > 0) {
          code += `, ${paramStrings.join(', ')}`;
        }
        
        code += ' do\n';
      });
      
      // Indent based on number of effects
      const indent = ''.padStart(effectsData.length * 2, ' ');
      
      // Add note with parameters
      if (useScale) {
        // Get the selected note for scale base and scale type
        const noteSelect = document.getElementById(`${noteId}-note`);
        const selectedNote = noteSelect.value.toLowerCase();
        
        // Find which octave is selected
        const octaveButtons = document.querySelectorAll(`#${noteId}-octave-selector .octave-button`);
        let selectedOctave = 3; // Default to octave 3
        
        octaveButtons.forEach((button, index) => {
          if (button.classList.contains('selected')) {
            selectedOctave = index + 1;
          }
        });
        
        const scaleType = document.getElementById(`${noteId}-scale-type`).value;
        code += `${indent}play (scale :${selectedNote}${selectedOctave}, ${scaleType}).tick`;
      } else {
        code += `${indent}play ${midiValue}`;
      }
      
      // Add parameters
      const params = [];
      if (parseFloat(attack) > 0) params.push(`attack: ${attack}`);
      if (parseFloat(sustain) > 0) params.push(`sustain: ${sustain}`);
      if (parseFloat(release) > 0) params.push(`release: ${release}`);
      if (parseFloat(amp) !== 1) params.push(`amp: ${amp}`);
      
      if (params.length > 0) {
        code += `, ${params.join(', ')}`;
      }
      
      code += '\n';
      
      // Close all effect blocks
      for (let i = 0; i < effectsData.length; i++) {
        code += ''.padStart(i * 2, ' ') + 'end\n';
      }
      
      return code;
    }
    
    function startLoop(loopId) {
      const loopCode = generateLoopCode(loopId);
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Send just the code, not a JSON object
        ws.send(loopCode);
        
        logMessage(`Started loop: ${loopId}`);
        logMessage(`Code: ${loopCode}`);
        
        // Update the status indicator
        document.getElementById(`${loopId}-status`).classList.add('loop-running');
        
        // Store the loop name for stopping later
        const loopName = document.getElementById(`${loopId}-name`).value;
        activeLoops[loopId] = loopName;
        
        // Update the sidebar
        updateSidebarLoops();
      } else {
        logMessage('Cannot start loop: not connected to server');
      }
    }
    
    function playNote(noteId) {
      const noteCode = generateNoteCode(noteId);
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Send just the code, not a JSON object
        ws.send(noteCode);
        
        logMessage(`Played note: ${noteId}`);
        logMessage(`Code: ${noteCode}`);
      } else {
        logMessage('Cannot play note: not connected to server');
      }
    }
    
    function stopLoop(loopId) {
      if (!activeLoops[loopId]) {
        logMessage(`Loop ${loopId} is not running`);
        return;
      }
      
      const loopName = activeLoops[loopId];
      const stopCode = `live_loop :${loopName} do\n  stop\nend`;
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Send just the code, not a JSON object
        ws.send(stopCode);
        
        logMessage(`Stopped loop: ${loopId}`);
        
        // Update the status indicator
        document.getElementById(`${loopId}-status`).classList.remove('loop-running');
        
        // Remove from active loops
        delete activeLoops[loopId];
        
        // Update the sidebar
        updateSidebarLoops();
      } else {
        logMessage('Cannot stop loop: not connected to server');
      }
    }
    
    function removeLoop(loopId) {
      // Stop the loop if it's running
      if (activeLoops[loopId]) {
        stopLoop(loopId);
      }
      
      // Remove the loop card from the DOM
      const loopCard = document.getElementById(loopId);
      if (loopCard) {
        loopCard.remove();
      }
      
      // Update the sidebar
      updateSidebarLoops();
    }
    
    function removeNote(noteId) {
      // Remove the note card from the DOM
      const noteCard = document.getElementById(noteId);
      if (noteCard) {
        noteCard.remove();
      }
    }
    
    function toggleNoteScaleMode(noteId) {
      const useScale = document.getElementById(`${noteId}-use-scale`).checked;
      document.getElementById(`${noteId}-scale-options`).style.display = useScale ? 'block' : 'none';
    }
    
    function playNoteByNumber(number) {
      const noteId = `note-${number}`;
      const noteCard = document.getElementById(noteId);
      
      if (noteCard) {
        // Add visual feedback
        noteCard.classList.add('playing');
        setTimeout(() => noteCard.classList.remove('playing'), 500);
        
        // Play the note
        playNote(noteId);
      }
    }
    
    // Functions for handling effects
    function addEffectToLoop(loopId) {
      const effectsContainer = document.getElementById(`${loopId}-effects-container`);
      const effectId = `${loopId}-effect-${Date.now()}`;
      
      // Create effect options
      let effectOptions = '';
      for (const [key, effect] of Object.entries(effects)) {
        effectOptions += `<option value="${key}">${effect.name}</option>`;
      }
      
      // Create the effect card
      const effectCard = document.createElement('div');
      effectCard.className = 'effect-card';
      effectCard.id = effectId;
      effectCard.innerHTML = `
        <div class="effect-header">
          <select class="effect-type" onchange="updateEffectParams('${effectId}', this.value)">
            ${effectOptions}
          </select>
          <button class="remove-effect" onclick="removeEffect('${effectId}')">Remove</button>
        </div>
        <div class="effect-params" id="${effectId}-params">
          <!-- Parameters will be added here -->
        </div>
      `;
      
      effectsContainer.appendChild(effectCard);
      
      // Initialize with the first effect in the list
      const firstEffect = Object.keys(effects)[0];
      updateEffectParams(effectId, firstEffect);
    }
    
    function addEffectToNote(noteId) {
      const effectsContainer = document.getElementById(`${noteId}-effects-container`);
      const effectId = `${noteId}-effect-${Date.now()}`;
      
      // Create effect options
      let effectOptions = '';
      for (const [key, effect] of Object.entries(effects)) {
        effectOptions += `<option value="${key}">${effect.name}</option>`;
      }
      
      // Create the effect card
      const effectCard = document.createElement('div');
      effectCard.className = 'effect-card';
      effectCard.id = effectId;
      effectCard.innerHTML = `
        <div class="effect-header">
          <select class="effect-type" onchange="updateEffectParams('${effectId}', this.value)">
            ${effectOptions}
          </select>
          <button class="remove-effect" onclick="removeEffect('${effectId}')">Remove</button>
        </div>
        <div class="effect-params" id="${effectId}-params">
          <!-- Parameters will be added here -->
        </div>
      `;
      
      effectsContainer.appendChild(effectCard);
      
      // Initialize with the first effect in the list
      const firstEffect = Object.keys(effects)[0];
      updateEffectParams(effectId, firstEffect);
    }
    
    function updateEffectParams(effectId, effectType) {
      const paramsContainer = document.getElementById(`${effectId}-params`);
      const effect = effects[effectType];
      
      if (!effect) return;
      
      let paramHtml = '';
      for (const [paramName, paramConfig] of Object.entries(effect.params)) {
        paramHtml += `
          <div class="effect-param">
            <label for="${effectId}-${paramName}">${paramName}:</label>
            <input 
              type="number" 
              id="${effectId}-${paramName}" 
              value="${paramConfig.default}" 
              min="${paramConfig.min}" 
              max="${paramConfig.max}" 
              step="${paramConfig.step}"
            >
          </div>
        `;
      }
      
      paramsContainer.innerHTML = paramHtml;
    }
    
    function removeEffect(effectId) {
      const effectCard = document.getElementById(effectId);
      if (effectCard) {
        effectCard.remove();
      }
    }
    
    function getEffectsForElement(elementId) {
      const effectsContainer = document.getElementById(`${elementId}-effects-container`);
      const effectCards = effectsContainer.querySelectorAll('.effect-card');
      const effectsData = [];
      
      effectCards.forEach(card => {
        const effectType = card.querySelector('.effect-type').value;
        const effect = effects[effectType];
        const params = {};
        
        // Get parameter values
        for (const paramName of Object.keys(effect.params)) {
          const paramInput = card.querySelector(`#${card.id}-${paramName}`);
          if (paramInput) {
            params[paramName] = parseFloat(paramInput.value);
          }
        }
        
        effectsData.push({
          type: effectType,
          params: params
        });
      });
      
      return effectsData;
    }
    
    // Add keyboard event listener to play notes with number keys
    document.addEventListener('keydown', function(event) {
      // Check if the key pressed is a number between 1-9
      const key = parseInt(event.key);
      if (!isNaN(key) && key >= 1 && key <= 9) {
        // Don't trigger if user is typing in an input field
        if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
          playNoteByNumber(key);
          event.preventDefault();
        }
      }
    });
    
    // Allow sending message with Enter key
    document.getElementById('message').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Add an initial loop
    addNewLoop();
    
    // Add an initial note
    addNewNote();
    
    // Function to update the sidebar loops list
    function updateSidebarLoops() {
      const sidebarLoops = document.getElementById('sidebar-loops');
      const emptyMessage = document.querySelector('.sidebar-empty-message');
      
      // Clear existing content except the empty message
      Array.from(sidebarLoops.children).forEach(child => {
        if (!child.classList.contains('sidebar-empty-message')) {
          child.remove();
        }
      });
      
      // Get all loops from the loops container
      const allLoopCards = document.querySelectorAll('.loop-card');
      
      // Show/hide empty message
      if (allLoopCards.length === 0) {
        emptyMessage.style.display = 'block';
        return;
      } else {
        emptyMessage.style.display = 'none';
      }
      
      // Add each loop to the sidebar
      allLoopCards.forEach(loopCard => {
        const loopId = loopCard.id;
        const loopName = document.getElementById(`${loopId}-name`).value;
        const synth = document.getElementById(`${loopId}-synth`).value;
        const isActive = activeLoops[loopId] !== undefined;
        
        // Create sidebar loop item
        const sidebarItem = document.createElement('div');
        sidebarItem.className = `sidebar-loop-item ${isActive ? 'active' : 'inactive'}`;
        sidebarItem.innerHTML = `
          <div class="sidebar-loop-name" onclick="selectLoop('${loopId}')" style="cursor: pointer;">${loopName}</div>
          <div class="sidebar-loop-details">Synth: ${synth}</div>
          <div class="sidebar-loop-controls">
            <button onclick="startLoop('${loopId}')" ${isActive ? 'disabled' : ''}>Play</button>
            <button onclick="stopLoop('${loopId}')" ${!isActive ? 'disabled' : ''}>Stop</button>
            <button onclick="removeLoop('${loopId}')">Delete</button>
          </div>
        `;
        
        sidebarLoops.appendChild(sidebarItem);
      });
    }
    
    // Initial update of sidebar
    updateSidebarLoops();
    
    // Function to select and scroll to a loop
    function selectLoop(loopId) {
      // Make sure we're on the loop creator tab
      const loopCreatorTab = document.getElementById('loop-creator');
      if (!loopCreatorTab.classList.contains('active')) {
        // Find and click the loop creator tab button
        const tabButtons = document.getElementsByClassName('tab-button');
        for (let i = 0; i < tabButtons.length; i++) {
          if (tabButtons[i].textContent.trim() === 'Loop Creator') {
            openTab({ currentTarget: tabButtons[i] }, 'loop-creator');
            break;
          }
        }
      }
      
      // Highlight the loop in main content
      const loopCard = document.getElementById(loopId);
      if (loopCard) {
        // Temporarily highlight the card
        loopCard.style.boxShadow = '0 0 10px #4CAF50';
        
        // Scroll to the loop card
        loopCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Remove highlight after a delay
        setTimeout(() => {
          loopCard.style.boxShadow = '';
        }, 2000);
      }
    }
    
    // Function to clear all loops
    function clearAllLoops() {
      // Check if WebSocket is connected first
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        logMessage('Cannot clear loops: not connected to server');
        return;
      }
      
      // Create a copy of active loop IDs before modifying
      const activeLoopIds = Object.keys(activeLoops);
      
      if (activeLoopIds.length === 0) {
        logMessage('No active loops to clear');
        return;
      }
      
      logMessage(`Clearing ${activeLoopIds.length} loops...`);
      
      // First stop all active loops using the copy
      for (const loopId of activeLoopIds) {
        const loopName = activeLoops[loopId];
        const stopCode = `live_loop :${loopName} do\n  stop\nend`;
        
        ws.send(stopCode);
        
        // Update status and remove from active loops
        const statusElement = document.getElementById(`${loopId}-status`);
        if (statusElement) {
          statusElement.classList.remove('loop-running');
        }
        delete activeLoops[loopId];
      }
      
      // Then remove all loop cards
      const loopCards = document.querySelectorAll('.loop-card');
      if (loopCards.length === 0) {
        logMessage('No loop cards found to remove');
      } else {
        loopCards.forEach(card => {
          card.remove();
        });
        logMessage(`Removed ${loopCards.length} loop cards`);
      }
      
      // Update the sidebar
      updateSidebarLoops();
      
      logMessage('All loops cleared');
    }
  </script>
</body>
</html> 